---

- name: ansible-virtualization-guest | guest-ssh | download ssh key to connect to vm
  ansible.builtin.get_url:
    url: "{{ vm.vm_ssh_key_url | default(ansible_vagrant_key_url) }}"
    dest: "/home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}"
    owner: "{{ whoami.stdout }}"
    group: "{{ whoami.stdout }}"
    mode: '0600'

- name: ansible-virtualization-guest | guest-ssh | download download public key to connect to vm
  ansible.builtin.get_url:
    url: "{{ vm.vm_ssh_key_url | default(ansible_vagrant_key_url) }}.pub"
    dest: "/home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}.pub"
    owner: "{{ whoami.stdout }}"
    group: "{{ whoami.stdout }}"
    mode: '0644'

- name: ansible-virtualization-guest | guest-ssh | ssh add current user info on remote
  ansible.builtin.shell: >
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}
    {{ ansible_virtualization_guest_vm_user }}@{{ hostcheck.ipaddr }}
    "sudo useradd {{ whoami.stdout }};sudo mkdir /home/{{ whoami.stdout }}/.ssh;"
  changed_when: false
  failed_when: false
  loop: "{{ currentvmnetinfo.msg }}" # default here should be the referenced interface
  loop_control:
    loop_var: hostcheck
  when: ansible_virtualization_guest_vm_user != whoami.stdout

- name: ansible-virtualization-guest | guest-ssh | ssh copy authorized key for current user
  ansible.builtin.shell: >
    scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}
    /home/{{ whoami.stdout }}/.ssh/authorized_keys
    {{ ansible_virtualization_guest_vm_user }}@{{ hostcheck.ipaddr }}:/home/{{ whoami.stdout }}/.ssh
  changed_when: false
  loop: "{{ currentvmnetinfo.msg }}" # default here should be the referenced interface
  loop_control:
    loop_var: hostcheck
  when: ansible_virtualization_guest_vm_user != whoami.stdout

- name: ansible-virtualization-guest | guest-ssh | update rights on remote
  ansible.builtin.shell: >
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}
    {{ ansible_virtualization_guest_vm_user }}@{{ hostcheck.ipaddr }}
    "sudo chown -R {{ whoami.stdout }}:{{ whoami.stdout }} /home/{{ whoami.stdout }}/.ssh;"
  changed_when: false
  loop: "{{ currentvmnetinfo.msg }}" # default here should be the referenced interface
  loop_control:
    loop_var: hostcheck
  when: ansible_virtualization_guest_vm_user != whoami.stdout

- name: ansible-virtualization-guest | guest-ssh | delete default user on vm
  ansible.builtin.shell: >
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}
    {{ ansible_virtualization_guest_vm_user }}@{{ hostcheck.ipaddr }}
    "sudo userdel -f {{ ansible_virtualization_guest_vm_user }};"
  changed_when: false
  failed_when: false
  loop: "{{ currentvmnetinfo.msg }}" # default here should be the referenced interface
  loop_control:
    loop_var: hostcheck
  when: ansible_virtualization_guest_vm_user != whoami.stdout

- name: ansible-virtualization-guest | guest-ssh | remove former guest key from host
  ansible.builtin.file:
    path: /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}
    state: absent

- name: ansible-virtualization-guest | guest-ssh | remove former guest public key from host
  ansible.builtin.file:
    path: /home/{{ whoami.stdout }}/.ssh/id_rsa{{ vm.name }}.pub
    state: absent
