---
- name: Converge
  hosts: all
  vars:
    manage_lvm: true
    lvm_groups:
      - vgname: non-persistent
        disks:
          - /dev/vdb
        create: true
        lvnames: []
    virtualization_guest_boxes:
      - name: fedoraGuestVM
        url: https://download.fedoraproject.org/pub/fedora/linux/releases/33/Cloud/x86_64/images/Fedora-Cloud-Base-Vagrant-33-1.2.x86_64.vagrant-libvirt.box
        memory_mb: 2048
        vcpus: 2
        ssh_port_on_host: 6752 # same as the one in molecule.yml
        recreate_machine: False
        ansible_groups:
          - directory
          - openid
        interfaces:
          - network: default
    users_group_list2:
      - name: libvirt
    systemusers_user_list:
      - name: libvirt
        group: libvirt
        groups: wheel
    libvirt_host_pools:
      - name: libvirt_vg
        type: lvm2
        source: non-persistent
    libvirt_host_networks:
      - name: default
        mode: nat
        bridge: virbr0
        ip: 192.168.121.1
        netmask: 255.255.255.0
        dhcp_start: 192.168.121.100
        dhcp_end: 192.168.121.200
  tasks:
    - name: "Include ansible-virtualization-guest"
      include_role:
        name: "ansible-virtualization-guest"
    - name: ansible-virtualization-guest | handler | execute hook # firewalld overriding vm NAT
      ansible.builtin.command:
        cmd: "sh /etc/libvirt/hooks/qemu"
      changed_when: False
      become: true